name: Delete Azure Resources to Reduce Billing in Trial Account

on:
  schedule:
    - cron: 0 19 * * *
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ minute (0 - 59)
# â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hour (0 - 23)
# â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of the month (1 - 31)
# â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ month (1 - 12 or JAN-DEC)
# â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of the week (0 - 6 or SUN-SAT)
# â”‚ â”‚ â”‚ â”‚ â”‚
# * * * * *
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  delete-resources:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout branch ${{ github.ref_name }}
      uses: actions/checkout@v6.0.2
      
    - name: Azure Login
      uses: Azure/login@v2.3.0
      with:
        client-id: 79def578-c3df-4261-af0a-2691f2d89e66
        tenant-id: 45498cdf-914d-4435-8790-31bcb1d6af30
        subscription-id: 331a949f-b38b-4711-a7fb-64ce9e156260

    - name: Check Current Azure Account
      uses: Azure/cli@v2.2.0
      with:
        # Specify the script here
        inlineScript: |
          az account show
          
    - name: Delete Azure Resource Groups
      uses: Azure/cli@v2.2.0
      with:
        # Specify the script here
        inlineScript: |
          LOCK_IDS=$(az lock list \
          --resource-group "$RG_NAME" \
          --query "[].id" \
          -o tsv)

          if [[ -z "$LOCK_IDS" ]]; then
            echo "âœ… No locks found."
          else
            echo "ðŸ§¹ Removing locks..."
            while read -r LOCK_ID; do
              echo "Deleting lock: $LOCK_ID"
              az lock delete --ids "$LOCK_ID"
            done <<< "$LOCK_IDS"
          fi
          
          for rg in $(az group list --query "[].name" -o tsv); do
            echo "Deleting resource group: $rg"
            az group delete --name "$rg" --yes --no-wait
          done
    
        
   
  
